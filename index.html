<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom OS Link</title>
    <style>
        body { font-family: 'Courier New', monospace; background: #222; color: #0f0; padding: 20px; }
        
        /* Layout & Utilities */
        .container { max-width: 800px; margin: 0 auto; border: 1px solid #0f0; padding: 20px; position: relative; }
        .hidden { display: none !important; }
        .btn-danger { border-color: #f00; color: #f00; }
        .btn-danger:hover { background: #f00; color: #000; }
        
        /* Google Button Styling */
        .btn-google { border-color: #4285F4; color: #4285F4; margin-bottom: 15px; font-weight: bold; padding: 15px; font-size: 1.1em; }
        .btn-google:hover { background: #4285F4; color: #fff; }
        
        /* Inputs */
        input, select, button { 
            background: #000; color: #0f0; border: 1px solid #0f0; 
            padding: 10px; margin: 5px 0; width: 100%; box-sizing: border-box;
            font-family: inherit; font-size: 1rem;
        }
        button:hover { background: #0f0; color: #000; cursor: pointer; }
        input:disabled { border-color: #555; color: #777; cursor: not-allowed; }

        /* Links */
        .link-btn { color: #555; text-decoration: underline; cursor: pointer; font-size: 0.8em; display: block; text-align: center; margin-top: 10px; }
        .link-btn:hover { color: #0f0; }

        /* Header */
        #top-bar { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed #0f0; padding-bottom: 10px; margin-bottom: 10px;}

        /* Chat Layout */
        #chat-interface { display: flex; height: 400px; margin-top: 10px; border: 1px solid #0f0; }
        #user-sidebar { width: 30%; border-right: 1px solid #0f0; background: #111; display: flex; flex-direction: column; }
        #message-area { width: 70%; display: flex; flex-direction: column; background: #000; }
        
        /* Message Feed */
        #msg-feed { flex-grow: 1; overflow-y: scroll; padding: 10px; }
        
        /* Message Styles */
        .msg { margin-bottom: 8px; padding: 5px; border-left: 3px solid #0f0; word-wrap: break-word;}
        
        /* Private DM Style */
        .msg.private { border-left-color: #ff00ff; color: #ff00ff; }
        
        /* --- NEW: ADMIN STYLE --- */
        .msg.admin { 
            border-left-color: #ff0;     /* Yellow Border */
            color: #ff0;                 /* Yellow Text */
            font-weight: bold;           /* Bold */
            font-size: 1.1em;            /* Slightly larger */
            background: rgba(255, 255, 0, 0.1); /* Subtle highlight background */
        }

        .msg-meta { font-size: 0.75em; opacity: 0.7; margin-bottom: 2px; }

        /* User List Items */
        .user-item { padding: 8px; cursor: pointer; border-bottom: 1px solid #333; }
        .user-item:hover { background: #333; }
        .user-item.selected { background: #0f0; color: #000; font-weight: bold; }
        
        /* Input Area at bottom */
        #input-area { display: flex; border-top: 1px solid #0f0; }
        #msg-input { border: none; flex-grow: 1; }
        #send-btn { width: auto; border: none; border-left: 1px solid #0f0; }
    </style>
</head>
<body>

    <div class="container">
        <!-- 1. LOGIN SCREEN -->
        <div id="login-screen">
            <h2 style="text-align: center;">>> SYSTEM ACCESS</h2>
            
            <div id="login-form">
                
                <label>FREQUENCY (Room Code):</label>
                <input type="text" id="room-code" placeholder="Enter Room">

                <div style="height: 20px;"></div>

                <!-- Google Auth Button (Primary) -->
                <button id="google-btn" onclick="handleGoogleFlow()" class="btn-google">
                    [ G ] SIGN IN WITH GOOGLE
                </button>

                <!-- Hidden Manual Override -->
                <div id="manual-login-area" class="hidden" style="border-top: 1px dashed #333; margin-top: 20px; padding-top: 10px;">
                    <label>MANUAL ID (Name):</label>
                    <input type="text" id="username" placeholder="Enter Name">
                    
                    <div id="role-container" class="hidden">
                        <label>ACCESS LEVEL:</label>
                        <select id="role-select">
                            <option value="student">Student</option>
                            <option value="teacher">Teacher (Admin)</option>
                        </select>
                    </div>

                    <button onclick="login()">INITIALIZE CONNECTION</button>
                </div>

                <a class="link-btn" onclick="toggleManual()">Toggle Manual Override</a>
            </div>
        </div>

        <!-- 2. MAIN APP SCREEN -->
        <div id="app-screen" class="hidden">
            <div id="top-bar">
                <span>FREQ: <b id="display-room"></b> | USER: <b id="display-name"></b></span>
                <button onclick="signOut()" class="btn-danger" style="width: auto; padding: 5px 15px;">DISCONNECT</button>
            </div>
            
            <div style="background: #111; padding: 5px; text-align: center; border: 1px dashed #555;">
                Target: <span id="target-display" style="font-weight:bold; color: #fff;">ALL (Broadcast)</span>
            </div>

            <div id="chat-interface">
                <!-- Left Sidebar: Users -->
                <div id="user-sidebar">
                    <div class="user-item selected" onclick="selectUser('ALL')">> BROADCAST ALL</div>
                    <div id="dynamic-user-list"></div>
                </div>

                <!-- Right Side: Messages -->
                <div id="message-area">
                    <div id="msg-feed"></div>
                    
                    <div id="input-area">
                        <input type="text" id="msg-input" placeholder="Enter data packet..." onkeydown="if(event.key==='Enter') sendMessage()">
                        <button id="send-btn" onclick="sendMessage()">SEND</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // =================================================================
        // FIREBASE CONFIGURATION (PRESERVED)
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyA_5r6DAUKkYv5TFP9XM3K3SnRBtmdUS0g",
            authDomain: "classroom-chat-756d5.firebaseapp.com",
            databaseURL: "https://classroom-chat-756d5-default-rtdb.firebaseio.com",
            projectId: "classroom-chat-756d5",
            storageBucket: "classroom-chat-756d5.firebasestorage.app",
            messagingSenderId: "805467042314",
            appId: "1:805467042314:web:c70e68f316c3a76d73a5f3",
            measurementId: "G-04X2N5MR75"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        // --- STATE ---
        let currentUser = { name: "", room: "", role: "student" }; 
        let selectedTarget = "ALL";
        let dbListeners = [];
        let authUserObject = null; // Stores the actual Google User object

        // --- ON LOAD ---
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // 1. Handle Room Code
            const roomParam = urlParams.get('room');
            if (roomParam) {
                const roomInput = document.getElementById("room-code");
                roomInput.value = roomParam;
                roomInput.disabled = true;
            }

            // 2. Handle Teacher Role
            const isTeacher = urlParams.get('teacher') === 'true';
            if (isTeacher) {
                currentUser.role = 'teacher';
                document.querySelector('h2').innerText += " (ADMIN MODE)";
                // Show manual controls for teacher just in case
                toggleManual();
            }

            // 3. Listen for Auth State (Auto-Detect Google Login)
            auth.onAuthStateChanged((user) => {
                const btn = document.getElementById("google-btn");
                if (user) {
                    // User is signed in.
                    console.log("User detected:", user.displayName);
                    authUserObject = user;
                    // Change button text to indicate readiness
                    btn.innerText = `[ G ] CONTINUE AS ${user.displayName.toUpperCase()}`;
                    btn.style.borderColor = "#0f0";
                    btn.style.color = "#0f0";
                    
                    // Auto-fill hidden username just in case logic needs it
                    document.getElementById("username").value = user.displayName;
                } else {
                    // No user is signed in.
                    authUserObject = null;
                    btn.innerText = "[ G ] SIGN IN WITH GOOGLE";
                    btn.style.borderColor = "#4285F4";
                    btn.style.color = "#4285F4";
                }
            });
        };

        // --- UI FUNCTIONS ---
        function toggleManual() {
            const area = document.getElementById("manual-login-area");
            if (area.classList.contains("hidden")) {
                area.classList.remove("hidden");
            } else {
                area.classList.add("hidden");
            }
        }

        // --- AUTH FLOW ---
        function handleGoogleFlow() {
            const room = document.getElementById("room-code").value.trim();
            if(!room) return alert("Please enter a Frequency (Room Code) first.");

            if (authUserObject) {
                // ALREADY AUTHENTICATED -> PROCEED TO LOGIN
                document.getElementById("username").value = authUserObject.displayName;
                login();
            } else {
                // NOT AUTHENTICATED -> TRIGGER POPUP
                const provider = new firebase.auth.GoogleAuthProvider();
                auth.signInWithPopup(provider)
                    .then((result) => {
                        // After successful sign-in, try to log in to room
                        authUserObject = result.user;
                        document.getElementById("username").value = result.user.displayName;
                        login();
                    }).catch((error) => {
                        console.error(error);
                        alert("Google Sign-In Failed: " + error.message);
                    });
            }
        }

        // --- CORE LOGIN LOGIC ---
        function login() {
            const name = document.getElementById("username").value.trim();
            const room = document.getElementById("room-code").value.trim();
            
            if(!name || !room) return alert("Credentials missing.");

            // CHECK: Does this room exist?
            // If I am a student, I cannot create rooms.
            if (currentUser.role === 'student') {
                db.ref(`rooms/${room}`).get().then((snapshot) => {
                    if (snapshot.exists()) {
                        // Room exists, proceed
                        proceedToApp(name, room);
                    } else {
                        // Room does NOT exist
                        alert("ACCESS DENIED: Room has not been opened by a Teacher yet.");
                        return; // Stop here
                    }
                }).catch((error) => {
                    console.error(error);
                    alert("Connection Error: " + error.message);
                });
            } else {
                // Teachers can create rooms
                proceedToApp(name, room);
            }
        }

        function proceedToApp(name, room) {
            currentUser.name = name;
            currentUser.room = room;

            // UI Switch
            document.getElementById("login-screen").classList.add("hidden");
            document.getElementById("app-screen").classList.remove("hidden");
            document.getElementById("display-room").innerText = room;
            
            const roleDisplay = currentUser.role === 'teacher' ? "ADMIN" : "STUDENT";
            document.getElementById("display-name").innerText = `${name} [${roleDisplay}]`;

            // Register User Presence
            const userRef = db.ref(`rooms/${room}/users/${name}`);
            userRef.set({ role: currentUser.role, lastSeen: Date.now() });
            userRef.onDisconnect().remove();

            // Start Listeners
            listenForMessages();
            listenForUsers();
        }

        function signOut() {
            if(currentUser.name && currentUser.room) {
                db.ref(`rooms/${currentUser.room}/users/${currentUser.name}`).remove();
            }
            
            // We do NOT sign out of Google auth here automatically, 
            // so they can rejoin easily. If you want full logout:
            // auth.signOut(); 

            // Detach listeners
            dbListeners.forEach(ref => ref.off());
            dbListeners = [];

            // Reset UI
            document.getElementById("msg-feed").innerHTML = "";
            document.getElementById("dynamic-user-list").innerHTML = "";
            document.getElementById("app-screen").classList.add("hidden");
            document.getElementById("login-screen").classList.remove("hidden");
            
            selectedTarget = "ALL";
            document.getElementById("target-display").innerText = "ALL (Broadcast)";
        }

        function listenForUsers() {
            const usersRef = db.ref(`rooms/${currentUser.room}/users`);
            dbListeners.push(usersRef);

            usersRef.on('value', (snapshot) => {
                const listDiv = document.getElementById("dynamic-user-list");
                listDiv.innerHTML = "";
                
                snapshot.forEach((child) => {
                    const uName = child.key;
                    const uData = child.val();
                    
                    if(uName !== currentUser.name) {
                        const div = document.createElement("div");
                        div.className = "user-item";
                        const prefix = uData.role === 'teacher' ? "[ADMIN] " : "> ";
                        div.innerText = prefix + uName;
                        
                        div.onclick = () => {
                            selectedTarget = uName;
                            document.getElementById("target-display").innerText = uName;
                            document.querySelectorAll(".user-item").forEach(el => el.classList.remove("selected"));
                            div.classList.add("selected");
                        };
                        listDiv.appendChild(div);
                    }
                });
            });
        }

        function listenForMessages() {
            const msgsRef = db.ref(`rooms/${currentUser.room}/messages`);
            dbListeners.push(msgsRef);

            msgsRef.limitToLast(100).on('child_added', (snapshot) => {
                const msg = snapshot.val();
                let show = false;

                if (currentUser.role === 'teacher') show = true; 
                else if (msg.sender === currentUser.name) show = true; 
                else if (msg.recipient === 'ALL') show = true; 
                else if (msg.recipient === currentUser.name) show = true; 

                if (show) {
                    const feed = document.getElementById("msg-feed");
                    const div = document.createElement("div");
                    const isPrivate = msg.recipient !== 'ALL';
                    const isAdmin = msg.role === 'teacher'; // Check role from message data
                    
                    // Construct Class String
                    let classes = "msg";
                    if (isPrivate) classes += " private";
                    if (isAdmin) classes += " admin";

                    div.className = classes;
                    
                    let meta = `[${new Date(msg.timestamp).toLocaleTimeString()}] ${msg.sender}`;
                    if(isPrivate) meta += ` -> ${msg.recipient}`;
                    if(isAdmin) meta = `[ADMIN BROADCAST] ${msg.sender}`;

                    div.innerHTML = `<div class="msg-meta">${meta}</div><div>${msg.text}</div>`;
                    feed.appendChild(div);
                    feed.scrollTop = feed.scrollHeight; 
                }
            });
        }

        function sendMessage() {
            const input = document.getElementById("msg-input");
            const text = input.value.trim();
            if(!text) return;

            db.ref(`rooms/${currentUser.room}/messages`).push({
                sender: currentUser.name,
                role: currentUser.role, // Important: Sending role with message
                recipient: selectedTarget,
                text: text,
                timestamp: Date.now()
            });
            input.value = "";
        }
    </script>
</body>
</html>
