<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom OS Link</title>
    <style>
        body { font-family: 'Courier New', monospace; background: #222; color: #0f0; padding: 20px; }
        
        /* Layout & Utilities */
        .container { max-width: 800px; margin: 0 auto; border: 1px solid #0f0; padding: 20px; position: relative; }
        .hidden { display: none !important; }
        .btn-danger { border-color: #f00; color: #f00; }
        .btn-danger:hover { background: #f00; color: #000; }
        .btn-google { border-color: #4285F4; color: #4285F4; margin-bottom: 15px; }
        .btn-google:hover { background: #4285F4; color: #fff; }
        
        /* Inputs */
        input, select, button { 
            background: #000; color: #0f0; border: 1px solid #0f0; 
            padding: 10px; margin: 5px 0; width: 100%; box-sizing: border-box;
            font-family: inherit; font-size: 1rem;
        }
        button:hover { background: #0f0; color: #000; cursor: pointer; }
        input:disabled { border-color: #555; color: #777; cursor: not-allowed; }

        /* Header */
        #top-bar { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed #0f0; padding-bottom: 10px; margin-bottom: 10px;}

        /* Chat Layout */
        #chat-interface { display: flex; height: 400px; margin-top: 10px; border: 1px solid #0f0; }
        #user-sidebar { width: 30%; border-right: 1px solid #0f0; background: #111; display: flex; flex-direction: column; }
        #message-area { width: 70%; display: flex; flex-direction: column; background: #000; }
        
        /* Message Feed */
        #msg-feed { flex-grow: 1; overflow-y: scroll; padding: 10px; }
        .msg { margin-bottom: 8px; padding: 5px; border-left: 3px solid #0f0; word-wrap: break-word;}
        .msg.private { border-left-color: #ff00ff; color: #ff00ff; }
        .msg-meta { font-size: 0.75em; opacity: 0.7; margin-bottom: 2px; }

        /* User List Items */
        .user-item { padding: 8px; cursor: pointer; border-bottom: 1px solid #333; }
        .user-item:hover { background: #333; }
        .user-item.selected { background: #0f0; color: #000; font-weight: bold; }
        
        /* Input Area at bottom */
        #input-area { display: flex; border-top: 1px solid #0f0; }
        #msg-input { border: none; flex-grow: 1; }
        #send-btn { width: auto; border: none; border-left: 1px solid #0f0; }
    </style>
</head>
<body>

    <div class="container">
        <!-- 1. LOGIN SCREEN -->
        <div id="login-screen">
            <h2 style="text-align: center;">>> SYSTEM ACCESS</h2>
            
            <div id="login-form">
                <!-- Google Auth Button -->
                <button onclick="googleLogin()" class="btn-google">
                    [ G ] USE GOOGLE IDENTITY
                </button>
                <div style="text-align: center; margin: 10px 0;">-- OR MANUAL OVERRIDE --</div>

                <label>IDENTIFICATION (Name):</label>
                <input type="text" id="username" placeholder="Enter Name">
                
                <label>FREQUENCY (Room Code):</label>
                <input type="text" id="room-code" placeholder="Enter Room">
                
                <div id="role-container" class="hidden">
                    <label>ACCESS LEVEL:</label>
                    <select id="role-select">
                        <option value="student">Student</option>
                        <option value="teacher">Teacher (Admin)</option>
                    </select>
                </div>

                <button onclick="login()" style="margin-top: 20px;">INITIALIZE CONNECTION</button>
            </div>
        </div>

        <!-- 2. MAIN APP SCREEN -->
        <div id="app-screen" class="hidden">
            <div id="top-bar">
                <span>FREQ: <b id="display-room"></b> | USER: <b id="display-name"></b></span>
                <button onclick="signOut()" class="btn-danger" style="width: auto; padding: 5px 15px;">DISCONNECT</button>
            </div>
            
            <div style="background: #111; padding: 5px; text-align: center; border: 1px dashed #555;">
                Target: <span id="target-display" style="font-weight:bold; color: #fff;">ALL (Broadcast)</span>
            </div>

            <div id="chat-interface">
                <!-- Left Sidebar: Users -->
                <div id="user-sidebar">
                    <div class="user-item selected" onclick="selectUser('ALL')">> BROADCAST ALL</div>
                    <div id="dynamic-user-list"></div>
                </div>

                <!-- Right Side: Messages -->
                <div id="message-area">
                    <div id="msg-feed"></div>
                    
                    <div id="input-area">
                        <input type="text" id="msg-input" placeholder="Enter data packet..." onkeydown="if(event.key==='Enter') sendMessage()">
                        <button id="send-btn" onclick="sendMessage()">SEND</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FIREBASE SDK (Added Auth) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // =================================================================
        // FIREBASE CONFIGURATION (PRESERVED)
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyA_5r6DAUKkYv5TFP9XM3K3SnRBtmdUS0g",
            authDomain: "classroom-chat-756d5.firebaseapp.com",
            databaseURL: "https://classroom-chat-756d5-default-rtdb.firebaseio.com",
            projectId: "classroom-chat-756d5",
            storageBucket: "classroom-chat-756d5.firebasestorage.app",
            messagingSenderId: "805467042314",
            appId: "1:805467042314:web:c70e68f316c3a76d73a5f3",
            measurementId: "G-04X2N5MR75"
        };
        // =================================================================

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        // --- STATE ---
        let currentUser = { name: "", room: "", role: "student" }; 
        let selectedTarget = "ALL";
        let dbListeners = [];

        // --- ON LOAD: PARSE URL & CHECK AUTH ---
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // 1. Handle Room Code
            const roomParam = urlParams.get('room');
            if (roomParam) {
                const roomInput = document.getElementById("room-code");
                roomInput.value = roomParam;
                roomInput.disabled = true;
            }

            // 2. Handle Teacher Role
            const isTeacher = urlParams.get('teacher') === 'true';
            if (isTeacher) {
                currentUser.role = 'teacher';
                document.querySelector('h2').innerText += " (ADMIN MODE)";
            }

            // 3. Check for existing Google Login (Auto-fill if found)
            auth.onAuthStateChanged((user) => {
                if (user) {
                    console.log("User detected:", user.displayName);
                    fillIdentity(user.displayName);
                }
            });
        };

        // --- AUTH FUNCTIONS ---

        function googleLogin() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then((result) => {
                    // This triggers the onAuthStateChanged above automatically
                }).catch((error) => {
                    alert("Auth Failed: " + error.message);
                });
        }

        function fillIdentity(name) {
            const nameInput = document.getElementById("username");
            nameInput.value = name;
            nameInput.disabled = true; // Lock it so they can't change it
            nameInput.style.borderColor = "#4285F4"; // Blue border to show trusted
        }

        // --- CORE FUNCTIONS ---

        function login() {
            const name = document.getElementById("username").value.trim();
            const room = document.getElementById("room-code").value.trim();
            
            if(!name || !room) return alert("Credentials missing.");

            currentUser.name = name;
            currentUser.room = room;

            // UI Switch
            document.getElementById("login-screen").classList.add("hidden");
            document.getElementById("app-screen").classList.remove("hidden");
            document.getElementById("display-room").innerText = room;
            
            const roleDisplay = currentUser.role === 'teacher' ? "ADMIN" : "STUDENT";
            document.getElementById("display-name").innerText = `${name} [${roleDisplay}]`;

            // 1. Add User to DB
            const userRef = db.ref(`rooms/${room}/users/${name}`);
            userRef.set({ role: currentUser.role, lastSeen: Date.now() });
            userRef.onDisconnect().remove();

            // 2. Start Listeners
            listenForMessages();
            listenForUsers();
        }

        function signOut() {
            // Remove user from DB
            if(currentUser.name && currentUser.room) {
                db.ref(`rooms/${currentUser.room}/users/${currentUser.name}`).remove();
            }
            
            // Sign out of Google too
            auth.signOut();

            // Detach listeners
            dbListeners.forEach(ref => ref.off());
            dbListeners = [];

            // Reset UI
            document.getElementById("msg-feed").innerHTML = "";
            document.getElementById("dynamic-user-list").innerHTML = "";
            document.getElementById("app-screen").classList.add("hidden");
            document.getElementById("login-screen").classList.remove("hidden");
            
            // Reset Inputs
            const nameInput = document.getElementById("username");
            nameInput.value = "";
            nameInput.disabled = false; // Unlock
            nameInput.style.borderColor = "#0f0";

            const urlParams = new URLSearchParams(window.location.search);
            if (!urlParams.get('room')) {
                document.getElementById("room-code").value = "";
            }
            
            selectedTarget = "ALL";
            document.getElementById("target-display").innerText = "ALL (Broadcast)";
        }

        function listenForUsers() {
            const usersRef = db.ref(`rooms/${currentUser.room}/users`);
            dbListeners.push(usersRef);

            usersRef.on('value', (snapshot) => {
                const listDiv = document.getElementById("dynamic-user-list");
                listDiv.innerHTML = "";
                
                snapshot.forEach((child) => {
                    const uName = child.key;
                    const uData = child.val();
                    
                    if(uName !== currentUser.name) {
                        const div = document.createElement("div");
                        div.className = "user-item";
                        const prefix = uData.role === 'teacher' ? "[ADMIN] " : "> ";
                        div.innerText = prefix + uName;
                        
                        div.onclick = () => {
                            selectedTarget = uName;
                            document.getElementById("target-display").innerText = uName;
                            document.querySelectorAll(".user-item").forEach(el => el.classList.remove("selected"));
                            div.classList.add("selected");
                        };
                        listDiv.appendChild(div);
                    }
                });
            });
        }

        function listenForMessages() {
            const msgsRef = db.ref(`rooms/${currentUser.room}/messages`);
            dbListeners.push(msgsRef);

            msgsRef.limitToLast(100).on('child_added', (snapshot) => {
                const msg = snapshot.val();
                let show = false;

                if (currentUser.role === 'teacher') show = true; 
                else if (msg.sender === currentUser.name) show = true; 
                else if (msg.recipient === 'ALL') show = true; 
                else if (msg.recipient === currentUser.name) show = true; 

                if (show) {
                    const feed = document.getElementById("msg-feed");
                    const div = document.createElement("div");
                    const isPrivate = msg.recipient !== 'ALL';
                    
                    div.className = isPrivate ? "msg private" : "msg";
                    
                    let meta = `[${new Date(msg.timestamp).toLocaleTimeString()}] ${msg.sender}`;
                    if(isPrivate) meta += ` -> ${msg.recipient}`;

                    div.innerHTML = `<div class="msg-meta">${meta}</div><div>${msg.text}</div>`;
                    feed.appendChild(div);
                    feed.scrollTop = feed.scrollHeight; 
                }
            });
        }

        function sendMessage() {
            const input = document.getElementById("msg-input");
            const text = input.value.trim();
            if(!text) return;

            db.ref(`rooms/${currentUser.room}/messages`).push({
                sender: currentUser.name,
                recipient: selectedTarget,
                text: text,
                timestamp: Date.now()
            });
            input.value = "";
        }
    </script>
</body>
</html>
